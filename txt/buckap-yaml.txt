steps:
  # Primeiro passo: clonar o repositório
  - name: 'gcr.io/cloud-builders/git'
    args: ['clone', 'https://github.com/michellsspy/motors-word.git', '.']

  # Segundo passo: criar o serviço de conta (se necessário)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Verifica se o serviço de conta já existe
        if [[ -z "sa-novadrive@novadrive-motors-428216.iam.gserviceaccount.com" ]]; then
          _SERVICE_ACCOUNT_EMAIL=$(gcloud iam service-accounts list \
            --filter="displayName:NovaDriveMotors Ingest" \
            --format="value(email)" \
            --project=novadrive-motors-428216)
          if [[ -z "sa-novadrive@novadrive-motors-428216.iam.gserviceaccount.com" ]]; then
            gcloud iam service-accounts create nova-drive-motors-ingest \
              --display-name="NovaDriveMotors Ingest" \
              --project=novadrive-motors-428216
            _SERVICE_ACCOUNT_EMAIL=$(gcloud iam service-accounts list \
              --filter="displayName:NovaDriveMotors Ingest" \
              --format="value(email)" \
              --project=novadrive-motors-428216)
          fi
        fi

  # Terceiro passo: criar a chave de serviço
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ ! -f "/workspace/key.json" ]]; then
          gcloud iam service-accounts keys create /workspace/key.json \
            --iam-account=sa-novadrive@novadrive-motors-428216.iam.gserviceaccount.com \
            --project=novadrive-motors-428216
        fi

  # Quarto passo: executar um script de build
  - name: 'gcr.io/cloud-builders/npm'
    args: ['install']
  - name: 'gcr.io/cloud-builders/npm'
    args: ['run', 'build']

  # Quinto passo: realizar o deploy
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'app'
      - 'deploy'
      - '--region=southamerica-east1'
      - '--machine-type=e2-highcpu-8'  # Troquei para um tipo de máquina E2

# Configurações adicionais
options:
  logging: 'CLOUD_LOGGING_ONLY'  # Opção de logging

# Configuração de substituições (substitutions)
substitutions:
  _NODE_ENV: 'production'
  _PROJECT_ID: 'novadrive-motors-428216'
  _REGION: 'southamerica-east1'
  _BUCKET_NAME: 'novadrive-motors/cloud-build'
  _SERVICE_ACCOUNT_EMAIL: 'sa-novadrive@novadrive-motors-428216.iam.gserviceaccount.com'
  _DEPLOYMENT_NAME: 'novadrive-motors/cloud-build'
  _DEPLOYMENT_REGION: 'southamerica-east1'
  _DEPLOYMENT_ZONE: 'southamerica-east1-a'
  _DEPLOYMENT_TIMEOUT: '600'
  _DEPLOYMENT_MAX_INSTANCES: '1'
  _DEPLOYMENT_MIN_INSTANCES: '1'
  _DEPLOYMENT_AUTOSCALE_ENABLED: 'true'
  _DEPLOYMENT_AUTOSCALE_MIN_INSTANCES: '1'
  _DEPLOYMENT_AUTOSCALE_MAX_INSTANCES: '10'
  _DEPLOYMENT_AUTOSCALE_CPU_TARGET: '0.5'
  _DEPLOYMENT_AUTOSCALE_COOL_DOWN_PERIOD: '60'
  _DEPLOYMENT_AUTOSCALE_DISK_SIZE_GB: '100'
  _DEPLOYMENT_AUTOSCALE_DISK_TYPE: 'pd-standard'
  _DEPLOYMENT_AUTOSCALE_NETWORK_PERFORMANCE_CONFIG: 'DEFAULT'
  _DEPLOYMENT_AUTOSCALE_MACHINE_TYPE: 'e2-highcpu-8'  # Tipo de máquina E2
  _DEPLOYMENT_AUTOSCALE_PREEMPTIBLE: 'false'
  _DEPLOYMENT_AUTOSCALE_DISK_AUTO_DELETE: 'true'
  _DEPLOYMENT_AUTOSCALE_DISK_SOURCE_IMAGE: 'centos-cloud/centos-7'
  _DEPLOYMENT_AUTOSCALE_DISK_BOOT: 'true'
  _DEPLOYMENT_AUTOSCALE_DISK_MODE: 'READ_WRITE'
